<html>
<head>
	<meta charset="utf-8">
	<title>Python - история одного импорта</title>
	<link rel="icon" href="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-favicon.png">
	<link rel="stylesheet" href="https://maximalisimus.github.io/Articles/html/main.css" type="text/css">
	<link rel="stylesheet" href="https://maximalisimus.github.io/Articles/html/zoom.css" type="text/css">
	<link rel="stylesheet" href="https://maximalisimus.github.io/Articles/html/table.css" type="text/css">
	<link rel="stylesheet" href="https://maximalisimus.github.io/Articles/html/frame.css">
	<link rel="stylesheet" href="https://maximalisimus.github.io/Articles/html/ol-li.css" type="text/css">
	<script src="https://maximalisimus.github.io/Articles/html/jquery.2.2.0.min.js"></script>
	<script type="text/javascript" src="https://maximalisimus.github.io/Articles/html/litezoom.js"></script>
</head>
<body>
	<div class="site">
		<div class="header">
			<div id="logo">
				<p style="margin:10px; padding:0px;">Python - история одного импорта</p>
			</div>
		</div>
		<div class="content">
			<center>
				<div class="images">
					<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-logo.png" width="500px"/>
				</div>
				<div style="clear:both"></div>
			</center>
		</div>
		<div class="content">
			<p><a name="oglavlenie"></a></p>
			<h2>Оглавление</h2>
			<ol>
				<li><a href="#part1">Введение</a></li>
				<li><a href="#part2">Структура &laquo;проекта-примера&raquo;</a></li>
				<li><a href="#part3">Cодержимое файлов &laquo;проекта-примера&raquo;</a></li>
				<li><a href="#part4">Импорт пакетов</a></li>
				<li><a href="#part5">Сравнение <span style="color:Red;">&laquo;pathlib&raquo;</span> с модулями <span style="color:Red;">&laquo;os&raquo;</span> и <span style="color:Red;">&laquo;os.path&raquo;</span></a></li>
				<li><a href="#part6">Библиотека <span style="color:Red;">&laquo;pathlib&raquo;</span>. Примеры</a></li>
				<li><a href="#part7">Немного <span style="color:Red;">&laquo;unittest&raquo;</span></a></li>
			</ol>
		</div>
		<div class="content">
			<p><a name="part1"></a></p>
			<h1>Введение</h1>
			<p>При создании любого <i>python-проекта</i> или одиночного скрипта с кодом мы часто пользуемся импортом, не совсем понимая или не помня, как именно он работает. В связи с чем, иногда могут возникать казусы и непредвиденные ситуации, которые порой сложно решить даже с использованием <i>&laquo;Google&raquo;</i> поиска.</p>
			<p>Сегодня моя задача объяснить почему возникают ошибки импорта пакетов или модулей, а также рассказать сложные темы простыми словами.
			Темы нашего сегодняшнего разговора очень простые, не смотря на то, что кажутся жутко сложными на первый взгляд. Однако, даже не углубляясь глубоко в дебри языка можно легко прийти к выводу - что любая задача решается очень легко.</p>
			<p>Даже если мы не знаем какая библиотека сможет решить ту или иную задачу, мы всегда должны понимать что способов решений может быть много, а может быть ни одного. В любом случае каждый раз вам придётся не только искать то или иное решение, но и искать его самостоятельно. Порою вы сможете найти сразу готовое решение и оно вам подойдет. <b>Однако, так будет не всегда.</b></p>
			<p>В любом случае вам нужно опираться на несколько базовых понятий:</p>
			<ol>
				<li>Какой нужен результат ?</li>
				<li>Решается ли задача, хотя бы на бумаге ?</li>
				<li>Алгоритмизация решения.</li>
			</ol>
			<p><b>Допустим</b>, вы уже решили ту или иную объемную задачу на бумаге, создали не только алгоритм решения, но и создали собственный python-пакет для обработки подобных задач в будущем.</p>
			<p><b>Идём дальше.</b> Теперь вам необходимо протестировать свой пакет не только на ошибки, но и на избыточность кода, а также соблюдение отступов, синтаксиса и многого другого.</p>
			<p>Вы конечно можете создать отдельный файл скрипта, например &laquo;test.py&raquo; в конкретной директории вашего пакета и протестировать модуль или метод модуля отдельно, так сказать, вручную. <b>Однако, это мягко говоря неудобно!</b></p>
			<p>Для каждого модуля вам придётся мучиться не только с отдельными скриптами, но с импортом своих модулей в этих скриптах, а также ещё и пространством имен из этих <u>скриптов-тестов</u>, т.к. эти файлы будут лежать в директориях ваших пакетов.</p>
			<p>Не говоря уже про попытку теста всего пакета в целом, ведь в этом случае - относительный импорт не работает и вам придется переместить ваш тест-скрипт на директорию выше.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.1.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №1" />
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.2.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №2" />
			</div>
			<p>В результате вам всё-таки придётся создать отдельную директорию для тестирования своего кода, в которой вы и будете хранить все <b>скрипты-тесты</b> вашего кода.</p>
			<p>Вот тут то и начинается вся магия <b>&laquo;Абры-Кадабры&raquo;</b> с импортом, т.к. в этом случае <span style="color:Red;">относительный импорт - не работает!</span></p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.3.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №3" />
			</div>
			<p>Что же тогда делать и как решить такую задачу?</p>
			<p><span style="color:Green;">Всё решается буквально 1...2 строчками кода </span> <b>-</b> <span style="color:Red;">но их необходимо понимать, чтобы применять правильно.</span></p>
			<p><b>Но - обо всём по порядку!</b></p>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
		</div>
		<div class="content">
			<p><a name="part2"></a></p>
			<h1>Структура &laquo;проекта-примера&raquo;</h1>
			<h2>Общая структура.</h2>
			<p>Для примера пусть будет следующая структура проекта.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-1.png" class="fz__minimized" alt="клик для увеличения" title="Strukture Project" />
			</div>
			<div class="codeses">
				<pre>
.
└── pkg
    ├── compatible
    │   ├── functions.py
    │   ├── __init__.py
    │   ├── subpackage_a
    │   │   ├── a.py
    │   │   └── __init__.py
    │   ├── subpackage_b
    │   │   ├── b.py
    │   │   ├── __init__.py
    │   │   └── test-pathlib-1.py
    │   └── test.py
    ├── test.py
    └── tests
        ├── __init__.py
        ├── test-abs-path.py
        ├── test-pathlib-1.py
        ├── test-pathlib-2.py
        ├── test-pkg-simple.py
        ├── test.py
        └── tmp.txt</pre>
			</div>
			<br>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
		</div>
		<div class="content">
			<p><a name="part3"></a></p>
			<h1>Cодержимое файлов &laquo;проекта-примера&raquo;</h1>
			<p>Определим содержимое всех указанных файлов-проекта. Для примера, пусть будет следующим.</p>
			<p>Пакет: <b>compatible</b></p>
			<p>Файл: <b>pkg/compatible/__init__.py</b></p>
			<p class="codes">
				from .functions import *</br>
				from .subpackage_a import *</br>
				from .subpackage_b import *
			</p>
			<p>Файл: <b>pkg/compatible/functions.py</b></p>
			<div class="codeses">
				<pre>
__all__ = ['getDateTimeStr']

from datetime import datetime

def getDateTimeStr(strFormat = "%d.%m.%Y-%H:%M:%S") -> str:
	dateTime = datetime.now()
	outDateTime = dateTime.strftime(strFormat)
	return outDateTime</pre>
			</div>
			<br>
			<hr>
			<br>
			<p>Под-пакет: <b>subpackage_a</b></p>
			<p>Файл пакета <i>subpackage_a</i>: <b>pkg/compatible/subpackage_a/__init__.py</b></p>
			<p class="codes">
				from .a import *
			</p>
			<p>Файл пакета <i>subpackage_a</i>: <b>pkg/compatible/subpackage_a/a.py</b></p>
			<div class="codeses">
				<pre>
__all__ = ['getPackageA']

from ..functions import *

def getPackageA():
	return 'Package A:' + getDateTimeStr()</pre>
			</div>
			<br>
			<hr>
			<br>
			<p>Под-пакет: <b>subpackage_b</b></p>
			<p>Файл пакета <i>subpackage_b</i>: <b>pkg/compatible/subpackage_b/__init__.py</b></p>
			<p class="codes">
				from .b import *
			</p>
			<p>Файл пакета <i>subpackage_b</i>: <b>pkg/compatible/subpackage_b/b.py</b></p>
			<div class="codeses">
				<pre>
__all__ = ['getPackageB']

from ..functions import *

def getPackageB():
	return 'Package B:' + getDateTimeStr()</pre>
			</div>
			<br>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
		</div>
		<div class="content">
			<p><a name="part4"></a></p>
			<h1>Импорт пакетов</h1>
			<h2>Простой импорт.</h2>
			<p>Обычно Python по команде <b>import</b> или <b>from</b> ищет указанные пакеты в каталогах, которые внесены в <b>sys.path</b> переменную среды.</p>
			<p>У данного списка для добавления нового пути поиска пакетов существует 2 метода: append и insert. 
			Работают они практически одинаково, за одним маленьким исключением - последний, вставляет строку по указанному индексу, например 0. Обе переменные нужны. <i>Мы к этому вернемся чуть позже.</i></p>
			<p>Если пакет по путям в <b>sys.path</b> не будет найден, Python выдаст ошибку.</p>
			<p>Однако, как вы можете заметить - при относительном импорте в пакете мы обращаемся к заданному каталогу относительно текущего. Тогда почему при запуске скрипта мы всё равно не можем импортировать пакет или модуль пакета на уровень выше?</p>
			<p><b>Это немного ошибочное мнение.</b></p>
			<p>Дело в том, что внутри пакета, в модуле - по команде <i>import</i> или <i>from</i> обращение происходит относительно файла самого модуля <b>из</b> которого происходит этот вызов, т.к. это модуль пакета.</p>
			<p>При простом запуске скрипта, т.е. исполняемого файла, по команде <i>import</i> или <i>from</i> происходит обращение не по относительной директории этого скрипта, а по путям заданным в <b>sys.path</b> переменной среды.</p>
			<p>В результате при обращении к несуществующему пакету, не найденому в <b>sys.path</b> мы получаем ошибку.</p>
			<p>Оказывается, просто, необходимо добавить директорию родителя в данную переменную среды.</p>
			<p>Отлично. Однако, остаётся ещё один вопрос: А какой именно каталог необходимо импортировать (../, ./ ии абсолютный путь) ?</p>
			<p>Давайте узнаем всё это на практике.</p>
			<p>Сначала добавим относительный путь и посмотрим - появился ли он в <b>sys.path</b>.</p>
			<p class="codes">
				import sys</br>
				sys.path.append('../')
			</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.4.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №4" />
			</div>
			<p>Есть.</p>
			<p>Теперь попробуем импортировать наш модуль.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.5.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №5" />
			</div>
			<p>Хм, ошибка. Может неправильно указали относительную директорию? Давайте попробуем с помощью модуля <b>pathlib</b>.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.6.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №6" />
			</div>
			<p>Опять ошибка. Может опять относительность импорта указали не верно? Попробуем ещё раз.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-2.7.png" class="fz__minimized" alt="клик для увеличения" title="Import attempt №7" />
			</div>
			<p>Хм, снова ошибка.</p>
			<p><u>Однако, здесь не всё так просто, как показалось на первый взгляд.</u></p>
			<p><b>Давайте разбираться!</b></p>
			<hr>
			<h2>Абсолютные и относительные пути.</h2>
			<p>Давайте сначала посмотрим как получить полную директорию из относительной при помощи того же модуля <b>pathlib</b>.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-3.png" class="fz__minimized" alt="клик для увеличения" title="Относительные и абсолютные пути" />
			</div>
			<p>Хорошо. С директориями разобрались.</p>
			<p>Есть такая встроенная переменная как &laquo;<b>__file__</b>&raquo;. Она указавает на текущий скрипт.</p>
			<p>Добавим новый путь поиска пакетов и попробуем импортировать наш пакет. Заодно посмотрим на пространстфо имен запускаемого скрипта, а также пространство имен импортируемого модуля. Если всё получится в консоль будут выведены все указанные значения.</p>
			<div class="codeses">
				<pre>
import pathlib
import sys

sys.path.append(str(pathlib.Path(__file__).resolve().parent.parent))

def main():
	for i in sys.path:
		print(i)
	import compatible
	print(dir(sys.modules[__name__]))
	print(dir(compatible), '\n')
	print(compatible.getPackageA())
	print(compatible.getPackageB())

if __name__ == '__main__':
	main()</pre>
			</div>
			<p>Смотрим на результат.</p>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-7.png" class="fz__minimized" alt="клик для увеличения" title="sys.path.append" />
			</div>
			<p><span style="color:Green;">Ура! Заработало!</span></p>
			<p><span style="color:Brown;">Однако, такой способ добавления не совсем правильный!</span> Однако, вполне рабочий.</p>
			<p>Обратите внимание на то, что необходимый путь поиска добавился в последнюю строку в &laquo;<b>sys.path</b>&raquo;.</p>
			<p>Таким образом, <b>Python</b> сначала переберет все остальные пути поиска, и только в последнюю очередь будет обращаться к вашей заданной директории.</p>
			<p>Лучшим решением, будет - добавление вашей директории на первое место. С этим как раз и поможет метод <b>insert</b>.</p>
			<div class="codeses">
				<pre>
import pathlib
import sys

sys.path.insert(0, str(pathlib.Path(__file__).resolve().parent.parent))

def main():
	for i in sys.path:
		print(i)
	import compatible
	print(dir(sys.modules[__name__]))
	print(dir(compatible), '\n')
	print(compatible.getPackageA())
	print(compatible.getPackageB())

if __name__ == '__main__':
	main()

				</pre>
			</div>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/Python-Imports_image/py-imports-8.png" class="fz__minimized" alt="клик для увеличения" title="sys.path.insert" />
			</div>
			<br>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
		</div>
		<div class="content">
			<p><a name="part5"></a></p>
			<h1>Сравнение <span style="color:Red;">&laquo;pathlib&raquo;</span> с модулями <span style="color:Red;">&laquo;os&raquo;</span> и <span style="color:Red;">&laquo;os.path&raquo;</span></h1>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
		</div>
		<div class="content">
			<p><a name="partN"></a></p>
			<h1>Part-1 H1</h1>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<p></p>
			<p class="codes">
				
			</p>
			<div class="codeses">
				<pre>

				</pre>
			</div>
			<div class="codeses">
				<pre>
<span style="color:blue;">#!/bin/bash</span>
...
script
...
<span style="color:blue;"># echo "result"</span>
				</pre>
			</div>
			<ul>
				<li><span style="color:Blue;">Blue</span></li>
				<li>Black</li>
				<li><span style="color:Red;">Reed</span></li>
				<li><span style="color:Yellow;">Yellow</span></li>
				<li><span style="color:Green;">Green</span></li>
			</ul>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
			<hr>
			<div id="page" class="clearfix">
				<img src="https://maximalisimus.github.io/Articles/image/image-0.jpg" class="fz__minimized" alt="клик для увеличения" title="Title" />
			</div>
			<hr>
			<p><a href="#oglavlenie">Перейти к оглавлению</a>.</p>
		</div>
		<div class="content">
			<p>Ну а сегодня на этом всё. Всем Добра и Удачи!</p>
		</div>	
		<div class="about">
			<p>Copyright &copy; xx.xx.xxxx by <a href="mailto:maximalis171091@yandex.ru">Mikhail Artamonov</a></p>
		</div>
		</br>
	</div>
	<script type="text/javascript">$('.fz__minimized').litezoom({speed:400, viewTitle:true});</script>
</body>
</html>
